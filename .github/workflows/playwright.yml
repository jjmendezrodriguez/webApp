##
# E2E Testing Workflow with Playwright
#
# Este workflow ejecuta tests End-to-End autom√°ticamente en:
# - Cada push a main
# - Cada Pull Request
#
# Caracter√≠sticas:
# - Tests en m√∫ltiples navegadores (Chrome, Firefox, Safari)
# - Cach√© de dependencias para velocidad
# - Generaci√≥n de reportes HTML
# - Upload de artifacts (screenshots, videos, traces)
#
# @see https://playwright.dev/docs/ci-intro
##
name: Playwright E2E Tests

# üîÑ Cu√°ndo ejecutar este workflow
on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

# üìã Jobs a ejecutar
jobs:
  test-e2e:
    # Sistema operativo (Ubuntu latest)
    runs-on: ubuntu-latest

    # Estrategia de matriz - Ejecutar en m√∫ltiples navegadores
    # Opcional: Comentar para ejecutar solo en Chromium y ahorrar tiempo
    strategy:
      fail-fast: false # No cancelar otros si uno falla
      matrix:
        browser: [chromium, firefox, webkit]

    steps:
      # 1Ô∏è‚É£ Checkout del c√≥digo
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Setup Bun (runtime JavaScript)
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      # 3Ô∏è‚É£ Cach√© de dependencias node_modules
      # Acelera workflow en ~5 minutos
      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun/install/cache
            frontEnd/node_modules
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lockb') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      # 4Ô∏è‚É£ Instalar dependencias del proyecto
      - name: Install dependencies
        working-directory: ./frontEnd
        run: bun install --frozen-lockfile

      # 5Ô∏è‚É£ Instalar navegadores de Playwright
      # Solo instala el navegador especificado en la matriz
      - name: Install Playwright browsers
        working-directory: ./frontEnd
        run: bunx playwright install --with-deps ${{ matrix.browser }}

      # 6Ô∏è‚É£ Ejecutar tests E2E
      # Playwright inicia el servidor autom√°ticamente con webServer config
      - name: Run Playwright tests
        working-directory: ./frontEnd
        run: bun test:e2e --project=${{ matrix.browser }}
        env:
          # Variables de entorno necesarias
          CI: true
          # üîí Supabase credentials (required for auth tests)
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}

      # 7Ô∏è‚É£ Subir reporte HTML (solo si falla)
      - name: Upload Playwright report
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: playwright-report-${{ matrix.browser }}
          path: frontEnd/playwright-report/
          retention-days: 7 # Mantener 7 d√≠as

      # 8Ô∏è‚É£ Subir test results (screenshots, videos, traces)
      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: test-results-${{ matrix.browser }}
          path: frontEnd/test-results/
          retention-days: 7

  # üìä Job que depende de test-e2e
  # Genera reporte consolidado (opcional)
  report:
    needs: test-e2e
    runs-on: ubuntu-latest
    if: always() # Ejecutar incluso si tests fallan

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Descargar todos los reportes (si existen)
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          path: all-reports

      # Listar artifacts descargados (debugging)
      - name: List downloaded artifacts
        run: ls -R all-reports || echo "No artifacts found"

      # TODO: Aqu√≠ podr√≠as generar un reporte consolidado
      # o publicar a GitHub Pages
